<!-- Button to open modal -->
<button type="button" class="btn btn-primary" (click)="openModal()">suggesstion</button>

<!-- Modal -->
<div
  class="modal fade"
  tabindex="-1"
  [ngClass]="{ 'show d-block': isModalOpen }"
  [style.background]="isModalOpen ? 'rgba(0,0,0,0.5)' : 'transparent'"
>
  <div
    class="modal-dialog modal-dialog-centered w-100 w-md-90 mx-auto modal-lg modal-dialog-scrollable"
  >
    <div class="modal-content custom-modal-spacing">
      <div
        class="modal-header border-0 position-relative d-flex flex-column flex-md-row justify-content-md-between align-items-md-center custom-modal-header text-center text-md-start"
      >
        <div
          class="d-flex flex-column flex-md-row align-items-center align-items-md-center gap-1 gap-md-2 w-100 ps-cs-6"
        >
          <h6 class="mb-0 text-sm-bs-inter-sb-grey-dark-18s-21l text-bs-inter-sb-grey-dark-15s-19l">
            Physical wellbeing Coaching History
          </h6>
          <span
            class="text-bs-inter-medium-green-16s-20l mt-1 mt-md-0 ms-md-3"
            *ngIf="getOverallCompliance() > 0"
          >
            Compliance: {{ getOverallCompliance() }}%
          </span>
        </div>

        <button
          type="button"
          class="btn-close position-absolute top-0 end-0 mt-2 me-2"
          (click)="closeModal()"
        ></button>
      </div>

      <div class="modal-body">
        <div class="container my-4 mx-auto">
          <!-- History card  -->
          <div class="card history-card rounded-4">
            <div class="card-body px-cs-16 py-cs-16">
              <!-- Coach + meta  -->
              <div class="d-flex justify-content-between align-items-start gap-3">
                <div class="d-flex align-items-center gap-3">
                  <img
                    src="./assets/images/male.svg"
                    alt="Coach avatar"
                    class="rounded-circle avatar"
                  />
                  <div class="d-flex flex-column flex-lg-row">
                    <div>
                      <div class="d-flex align-items-center">
                        <div class="text-bs-inter-medium-black-mid-16s-20l">Coach Name</div>
                      </div>
                      <div class="text-bs-roboto-reg-grey-dark-13s-18l">Name&#64;tvsmotor.com</div>
                    </div>
                    <div class="mx-lg-5">
                      <span
                        class="text-bs-inter-medium-black-secondary-13s-18l text-lg-bs-inter-medium-black-secondary-15s-19l mx-lg-5"
                        >Advices : Advice Given - Frequency - Comments</span
                      >
                    </div>
                  </div>
                </div>
                <div class="d-flex flex-column align-items-end no-shrink">
                  <span
                    class="bg-brand text-white py-cs-4 px-cs-16 text-sm-bs-inter-medium-white-14s-17l text-bs-inter-medium-white-12s-15l"
                    >{{ submittedSurveys().length + 1 }}/{{ submittedSurveys().length + 1 }}</span
                  >
                  <div
                    class="text-bs-inter-medium-grey-mid-13s-18l text-lg-bs-inter-medium-grey-mid-15s-19l mt-2"
                  >
                    {{ surveysArray.at(0).get('date')?.value }}
                  </div>
                </div>
              </div>

              <hr class="my-3 dashed" />

              <!-- Column headers  -->
              <div
                class="row g-3 mb-2 px-1 small text-muted fw-medium align-items-center d-none d-lg-flex ps-2"
              >
                <div class="col-3 text-bs-inter-reg-grey-medium-light-13s-18l me-3">
                  Advice Given
                </div>
                <div class="col-4 text-bs-inter-reg-grey-medium-light-13s-18l ps-5">Frequency</div>
                <div class="col-3 text-bs-inter-reg-grey-medium-light-13s-18l ps-3">Remarks</div>
              </div>

              <!-- Form  -->
              <form [formGroup]="surveyForm" (ngSubmit)="onSubmit()">
                <div formArrayName="surveys" class="d-flex flex-column gap-3">
                  @for (survey of surveysArray.controls; track survey; let i = $index) {
                    <div class="row g-3 align-items-center" [formGroupName]="$index">
                      <!-- Advice Given -->
                      <div class="col">
                        <label
                          class="d-md-block d-lg-none text-bs-inter-reg-grey-medium-light-13s-18l ms-2 mb-1"
                          >Advice Given</label
                        >
                        <input
                          type="text"
                          formControlName="adviceGiven"
                          class="form-control rounded-pill input-pill custom-input"
                          maxlength="150"
                          aria-label="Advice Given"
                        />
                      </div>
                      <!-- Frequency -->
                      <div class="col">
                        <label
                          class="d-md-block d-lg-none text-bs-inter-reg-grey-medium-light-13s-18l ms-2 mb-1"
                          >Frequency</label
                        >
                        <input
                          type="text"
                          formControlName="frequency"
                          class="form-control rounded-pill input-pill custom-input"
                          maxlength="150"
                          aria-label="Frequency"
                        />
                      </div>
                      <!-- Remarks -->
                      <div class="col">
                        <label
                          class="d-md-block d-lg-none text-bs-inter-reg-grey-medium-light-13s-18l ms-2 mb-1"
                          >Remarks</label
                        >
                        <input
                          type="text"
                          formControlName="remarks"
                          class="form-control input-pill custom-input"
                          maxlength="150"
                          aria-label="Remarks"
                        />
                      </div>

                      <!-- Mobile: same message below the section -->
                      <div
                        class="text-danger d-block d-lg-none mt-1 ms-2"
                        *ngIf="survey.invalid && survey.touched"
                      >
                        Please fill in all fields for row {{ $index + 1 }}
                      </div>
                      <!--  Button column -->
                      <div
                        class="col-auto action-buttons d-flex justify-content-end justify-content-lg-end gap-1 mt-sm-3 pt-2 pr-5 pt-lg-0 pr-lg-0"
                      >
                        @if (surveysArray.length > 1) {
                          <button
                            type="button"
                            class="btn action-btn remove"
                            (click)="removeSurvey(i)"
                            aria-label="Remove row"
                          >
                            <img src="./assets/icons/remove.svg" alt="Remove" />
                          </button>
                        }

                        @if (i === surveysArray.length - 1) {
                          <button
                            type="button"
                            class="btn action-btn add"
                            (click)="addSurvey()"
                            aria-label="Add row"
                          >
                            <img src="./assets/icons/add.svg" alt="Remove" />
                          </button>
                        }
                      </div>
                    </div>
                    <!-- Validation messages -->
                    <!-- Desktop (â‰¥992px) -->
                    <div
                      class="text-danger d-none d-lg-block ms-3"
                      *ngIf="survey.invalid && survey.touched"
                    >
                      Please fill in all fields for row {{ $index + 1 }}
                    </div>
                  }
                </div>
              </form>
            </div>
          </div>
          <!-- Check if there are submissions -->
          @if (submittedSurveys().length > 0) {
            <!-- Loop over each submission -->
            @for (
              submission of submittedSurveys().slice().reverse();
              track submission.id;
              let i = $index
            ) {
              <div class="text-bs-inter-reg-grey-medium-light-13s-18l px-2 py-2 mt-3">
                Advice Given
              </div>
              <div class="card history-card rounded-4 mb-3">
                <div class="card-body px-cs-16 py-cs-16">
                  <!-- Coach + meta -->
                  <div class="d-flex justify-content-between align-items-start gap-3">
                    <div class="d-flex align-items-center gap-3">
                      <img
                        src="./assets/images/male.svg"
                        alt="Coach avatar"
                        class="rounded-circle avatar"
                      />
                      <div class="d-flex">
                        <div>
                          <div class="d-flex align-items-center">
                            <div class="text-bs-inter-medium-black-mid-16s-20l">Coach Name</div>
                            <div
                              class="small d-flex align-items-center mt-1"
                              *ngIf="submission.rating && submission.rating > 0"
                            >
                              <span class="ms-2 fw-semibold text-warning">{{
                                submission.rating || 0
                              }}</span>
                              <img
                                src="./assets/icons/rating-star.svg"
                                alt="rating star"
                                class="rating-star-icon"
                              />
                            </div>
                          </div>
                          <div class="text-bs-roboto-reg-grey-dark-13s-18l">
                            Name&#64;tvsmotor.com
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="d-flex flex-column align-items-end no-shrink">
                      <span
                        class="bg-brand text-white py-cs-4 px-cs-16 text-sm-bs-inter-medium-white-14s-17l text-bs-inter-medium-white-12s-15l"
                      >
                        {{ submittedSurveys().length - i }}/{{ submittedSurveys().length + 1 }}
                      </span>
                      <div
                        class="text-bs-inter-medium-grey-mid-13s-18l text-lg-bs-inter-medium-grey-mid-15s-19l mt-2"
                      >
                        {{ submission.date }}
                      </div>
                    </div>
                  </div>

                  <hr class="my-3 dashed" />

                  <!-- Column headers -->
                  <div
                    class="mb-2 d-flex flex-column flex-md-row justify-content-between pe-0 pe-md-5"
                  >
                    <div
                      class="d-none d-md-block text-bs-inter-medium-black-secondary-15s-19l mb-1 mb-md-0"
                    >
                      Advices : Advice Given - Frequency - Comments
                    </div>
                    <div class="d-none d-md-block text-bs-inter-medium-black-secondary-15s-19l">
                      Your Progress
                    </div>
                    <div
                      class="d-block d-md-none text-bs-inter-medium-black-secondary-15s-19l text-center"
                    >
                      Advices : Advice Given - Frequency - Comments
                    </div>
                  </div>

                  <!-- Survey list for this submission -->
                  @for (survey of submission.surveys; track survey) {
                    <div
                      class="survey-item py-2 px-3 pe-md-5 d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center w-100 border-bottom"
                    >
                      <div class="d-flex flex-column w-100">
                        <!-- Advice Section -->
                        <div class="d-flex align-items-center">
                          <div
                            class="badge rounded-circle bg-primary d-inline-flex align-items-center justify-content-center flex-shrink-0 me-2 blue-circle"
                          ></div>
                          <div class="text-bs-inter-reg-grey-dark-mid-13s-18l">
                            {{ survey.adviceGiven }} - {{ survey.frequency }} - {{ survey.remarks }}
                          </div>
                        </div>

                        <!-- Mobile-only: progress section -->
                        <div
                          class="d-md-none mt-2 ps-4 text-bs-inter-reg-black-light-12s-15l progress-mobile"
                        >
                          <span class="text-bs-inter-medium-grey-mid-12s-15l me-1"
                            >Your Progress:</span
                          >
                          {{
                            survey.followStatus === 'following'
                              ? 'I am Following'
                              : survey.followStatus === 'not-following'
                                ? 'I am not Following'
                                : 'Pending'
                          }}
                        </div>
                      </div>

                      <!-- Desktop version -->
                      <div
                        class="text-bs-inter-reg-black-light-13s-17l text-bs-inter-reg-black-light-14s-17l mt-2 mt-md-0 text-md-end w-25 w-md-auto d-none d-md-inline-block"
                      >
                        {{
                          survey.followStatus === 'following'
                            ? 'I am Following'
                            : survey.followStatus === 'not-following'
                              ? 'I am not Following'
                              : 'Pending'
                        }}
                      </div>
                    </div>
                  }

                  <!-- Feedback section -->
                  @if (submission.feedback && submission.feedback.trim() !== '') {
                    <div
                      class="d-flex align-items-center justify-content-md-start justify-content-center gap-5 gap-md-2 rounded mt-2 feedback-section py-cs-5 pe-3"
                    >
                      <div class="d-flex ms-md-3 gap-1">
                        <img src="./assets/icons/feedback.svg" alt="feedback" />
                        <span class="text-bs-inter-medium-purple-12s-15l ps-cs-6">Feedback</span>
                      </div>

                      <div class="text-bs-inter-reg-grey-medium-light-13s-18l ps-cs-28">
                        {{ submission.feedback }}
                      </div>
                    </div>
                  }
                </div>
              </div>
            }
          }
        </div>
      </div>
      <div class="modal-footer justify-content-lg-end justify-content-center">
        <button type="button" class="btn btn-cancel" (click)="clearAll()">Cancel</button>
        <button type="button" class="btn custom-submit-btn" (click)="onSubmit()">Submit</button>
      </div>
    </div>
  </div>
</div>
