<!-- Buttons for each submission -->
<div *ngFor="let sub of submissions(); trackBy: trackBySubmission">
  <button type="button" class="btn btn-primary" (click)="openModal(sub)">
    Feedback - {{ sub.date }}
  </button>
</div>

<!-- Modal -->
<div
  class="modal fade"
  tabindex="-1"
  [ngClass]="{ 'show d-block': isModalOpen }"
  [style.background]="isModalOpen ? 'rgba(0,0,0,0.5)' : 'transparent'"
>
  <div
    class="modal-dialog modal-dialog-centered w-100 w-md-90 mx-auto modal-lg modal-dialog-scrollable"
  >
    <div class="modal-content custom-modal-spacing">
      <!-- Modal Header -->
      <div
        class="modal-header border-0 position-relative d-flex flex-column flex-md-row justify-content-md-between align-items-md-center custom-modal-header text-center text-md-start"
      >
        <div
          class="d-flex flex-column flex-md-row align-items-center align-items-md-center gap-1 gap-md-2 w-100 ps-cs-6 pb-3"
        >
          <h6 class="mb-0 text-sm-bs-inter-sb-grey-dark-18s-21l text-bs-inter-sb-grey-dark-15s-19l">
            Physical wellbeing Coaching History
          </h6>
          <span
            class="text-bs-inter-medium-green-16s-20l mt-1 mt-md-0 ms-md-3"
            *ngIf="getCompliance() > 0"
          >
            Compliance : {{ getCompliance() }}%
          </span>
        </div>

        <button
          type="button"
          class="btn-close position-absolute top-0 end-0 mt-2 me-2"
          (click)="closeModal()"
        ></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body">
        <div class="card history-card rounded-4">
          <div class="card-body px-cs-16 py-cs-16">
            <!-- Coach + meta -->
            <div class="d-flex justify-content-between align-items-start gap-3">
              <div class="d-flex align-items-center gap-3">
                <img
                  src="./assets/images/male.svg"
                  alt="Coach avatar"
                  class="rounded-circle avatar"
                />
                <div class="d-flex">
                  <div>
                    <div class="text-bs-inter-medium-black-mid-16s-20l">Coach Name</div>
                    <div class="text-bs-roboto-reg-grey-dark-13s-18l">Name&#64;tvsmotor.com</div>
                  </div>
                </div>
              </div>
              <div class="d-flex flex-column align-items-end no-shrink">
                <span
                  class="bg-brand text-white py-cs-4 px-cs-16 text-sm-bs-inter-medium-white-14s-17l text-bs-inter-medium-white-12s-15l"
                >
                  {{ selectedSubmissionIndex + 1 }}/{{ submissions().length }}
                </span>
                <div
                  class="text-bs-inter-medium-grey-mid-13s-18l text-lg-bs-inter-medium-grey-mid-15s-19l mt-2"
                >
                  {{ selectedSubmission?.date }}
                </div>
              </div>
            </div>

            <hr class="my-3 dashed" />

            <!-- Column headers -->
            <div class="mb-2 d-flex flex-column flex-md-row justify-content-between pe-0 pe-md-5">
              <div
                class="d-none d-md-block text-bs-inter-medium-black-secondary-15s-19l mb-1 mb-md-0"
              >
                Advices : Advice Given - Frequency - Comments
              </div>
              <div class="d-none d-md-block text-bs-inter-medium-black-secondary-15s-19l">
                Your Progress
              </div>
              <div
                class="d-block d-md-none text-bs-inter-medium-black-secondary-15s-19l text-center"
              >
                Advices : Advice Given - Frequency - Comments
              </div>
            </div>

            <!-- Feedback / Survey list -->
            <div *ngFor="let survey of selectedSubmission?.surveys; trackBy: trackBySurvey">
              <div
                class="survey-item py-2 px-3 pe-md-5 d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center w-100 border-bottom"
              >
                <div class="d-flex flex-column w-100">
                  <!-- Advice Section -->
                  <div class="d-flex align-items-center">
                    <div
                      class="badge rounded-circle bg-primary d-inline-flex align-items-center justify-content-center flex-shrink-0 me-2 blue-circle"
                    ></div>
                    <div class="text-bs-inter-reg-grey-dark-mid-13s-18l">
                      {{ survey.adviceGiven }} - {{ survey.frequency }} - {{ survey.remarks }}
                    </div>
                  </div>

                  <!-- Mobile-only: progress section -->
                  <div
                    class="d-md-none mt-2 ps-4 text-bs-inter-reg-black-light-12s-15l progress-mobile"
                  >
                    <span class="text-bs-inter-medium-grey-mid-12s-15l me-1">Your Progress:</span>
                    <div class="follow-dropdown">
                      <select
                        [(ngModel)]="survey.followStatus"
                        (change)="onFollowStatusChange(survey, survey.followStatus || '')"
                      >
                        <option value="" disabled>Select</option>
                        <option value="following">I am Following</option>
                        <option value="not-following">I am not Following</option>
                      </select>
                      <img
                        class="dropdown-icon"
                        src="./assets/icons/dropdown.svg"
                        alt="dropdown icon"
                      />
                    </div>

                    <!-- Error message for mobile -->
                    <div
                      *ngIf="submitted && followStatusErrors[survey.adviceGiven]"
                      class="text-danger mt-1 small d-md-none"
                    >
                      Please select
                    </div>
                  </div>
                </div>

                <!-- Desktop version dropdown -->
                <div
                  class="text-bs-inter-reg-black-light-13s-17l text-bs-inter-reg-black-light-14s-17l mt-2 mt-md-0 text-md-end w-25 w-md-auto d-none d-md-inline-block"
                >
                  <div class="follow-dropdown">
                    <select
                      [(ngModel)]="survey.followStatus"
                      (change)="onFollowStatusChange(survey, survey.followStatus || '')"
                    >
                      <option value="" disabled>Select</option>
                      <option value="following">I am Following</option>
                      <option value="not-following">I am not Following</option>
                    </select>
                    <img
                      class="dropdown-icon"
                      src="./assets/icons/dropdown.svg"
                      alt="dropdown icon"
                    />
                  </div>

                  <!-- Error message for desktop -->
                  <div
                    *ngIf="submitted && followStatusErrors[survey.adviceGiven]"
                    class="text-danger mt-1 small d-none d-md-block text-nowrap"
                  >
                    Please select
                  </div>
                </div>
              </div>
            </div>

            <!-- Ratings -->
            <div
              *ngIf="selectedSubmission"
              class="d-flex align-items-center justify-content-center my-cs-25 flex-column"
            >
              <app-star-rating
                [(rating)]="selectedSubmission.rating"
                [max]="5"
                [starSrc]="'./assets/icons/rating-star.svg'"
                [starSize]="'34px'"
                (ratingChange)="onRatingChange($event)"
              ></app-star-rating>

              <!-- Rating validation errors -->
              <div
                *ngIf="submitted && ratingError"
                class="text-danger small text-center d-block mt-2"
              >
                Please provide a rating
              </div>
            </div>

            <!-- Feedback textarea -->
            <div class="px-cs-10">
              <div class="text-bs-inter-medium-black-secondary-15s-19l">Feedback</div>
              <div class="mb-3" *ngIf="selectedSubmission">
                <textarea
                  class="form-control custom-textarea"
                  rows="4"
                  [(ngModel)]="selectedSubmission.feedback"
                  maxlength="250"
                  (input)="onFeedbackChange()"
                ></textarea>
                <!-- Feedback validation errors -->

                <div *ngIf="submitted && feedbackError" class="text-danger mt-1 small text-end">
                  Please enter your feedback
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer justify-content-lg-end justify-content-center">
        <button type="button" class="btn btn-cancel" (click)="closeModal()">Cancel</button>
        <button type="button" class="btn custom-submit-btn" (click)="onSubmit()">Submit</button>
      </div>
    </div>
  </div>
</div>
