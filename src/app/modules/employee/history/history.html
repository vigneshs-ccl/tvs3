<!-- Button to open modal -->
<button type="button" class="btn btn-primary" (click)="openModal()">History</button>

<!-- Modal -->
<div
  class="modal fade"
  tabindex="-1"
  [ngClass]="{ 'show d-block': isModalOpen }"
  [style.background]="isModalOpen ? 'rgba(0,0,0,0.5)' : 'transparent'"
>
  <div class="modal-dialog modal-dialog-centered w-90 mx-auto modal-lg modal-dialog-scrollable">
    <div class="modal-content custom-modal-spacing">
      <div
        class="modal-header border-0 position-relative d-flex flex-column flex-md-row justify-content-md-between align-items-md-center custom-modal-header text-center text-md-start"
        *ngIf="submissions().length > 0"
      >
        <div
          class="d-flex flex-column flex-md-row align-items-center align-items-md-center gap-1 gap-md-2 w-100 ps-cs-6"
        >
          <h6 class="mb-0 text-sm-bs-inter-sb-grey-dark-18s-21l text-bs-inter-sb-grey-dark-15s-19l">
            Physical wellbeing Coaching History
          </h6>
          <span
            class="text-bs-inter-medium-green-16s-20l mt-1 mt-md-0 ms-md-3"
            *ngIf="getOverallCompliance() > 0"
          >
            Compliance: {{ getOverallCompliance() }}%
          </span>
        </div>

        <button
          type="button"
          class="btn-close position-absolute top-0 end-0 mt-2 me-2"
          (click)="closeModal()"
        ></button>
      </div>

      <div class="modal-body">
        <div class="container my-4 mx-auto">
          <ng-container *ngIf="submissions().length > 0; else noData">
            <!-- Loop over submissions (latest first) -->
            <div
              *ngFor="
                let submission of submissions().slice().reverse();
                let first = first;
                let i = index;
                trackBy: trackBySubmission
              "
              class="card history-card rounded-4 mb-3"
            >
              <div class="card-body px-cs-16 py-cs-16">
                <!-- Coach + meta -->
                <div class="d-flex justify-content-between align-items-start gap-3">
                  <div class="d-flex align-items-center gap-3">
                    <img
                      src="./assets/images/male.svg"
                      alt="Coach avatar"
                      class="rounded-circle avatar"
                    />
                    <div class="d-flex">
                      <div>
                        <div class="d-flex align-items-center">
                          <div class="text-bs-inter-medium-black-mid-16s-20l">Coach Name</div>
                          @if (submission.rating && submission.rating > 0) {
                            <div class="small d-flex align-items-center mt-1">
                              <span class="ms-2 fw-semibold text-warning">{{
                                submission.rating
                              }}</span>
                              <img
                                src="./assets/icons/rating-star.svg"
                                alt="rating star"
                                class="rating-star-icon"
                              />
                            </div>
                          }
                        </div>
                        <div class="text-bs-roboto-reg-grey-dark-13s-18l">
                          Name&#64;tvsmotor.com
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex flex-column align-items-end no-shrink">
                    <span
                      class="bg-brand text-white py-cs-4 px-cs-16 text-sm-bs-inter-medium-white-14s-17l text-bs-inter-medium-white-12s-15l"
                    >
                      {{ submissions().length - i }}/{{ submissions().length }}
                    </span>
                    <div
                      class="text-bs-inter-medium-grey-mid-13s-18l text-lg-bs-inter-medium-grey-mid-15s-19l mt-2"
                    >
                      {{ submission.date }}
                    </div>
                  </div>
                </div>

                <hr class="my-3 dashed" />

                <!-- Column headers -->
                <div
                  class="mb-2 d-flex flex-column flex-md-row justify-content-between pe-0 pe-md-5"
                >
                  <div
                    class="d-none d-md-block text-bs-inter-medium-black-secondary-15s-19l mb-1 mb-md-0"
                  >
                    Advices : Advice Given - Frequency - Comments
                  </div>
                  <div class="d-none d-md-block text-bs-inter-medium-black-secondary-15s-19l">
                    Your Progress
                  </div>
                  <div
                    class="d-block d-md-none text-bs-inter-medium-black-secondary-15s-19l text-center"
                  >
                    Advices : Advice Given - Frequency - Comments
                  </div>
                </div>

                <!-- Survey list for this submission -->
                <div *ngFor="let survey of submission.surveys; trackBy: trackBySurvey">
                  <div
                    class="survey-item py-2 px-3 pe-md-5 d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center w-100 border-bottom"
                  >
                    <div class="d-flex flex-column w-100">
                      <!-- Advice Section -->
                      <div class="d-flex align-items-center">
                        <div
                          class="badge rounded-circle bg-primary d-inline-flex align-items-center justify-content-center flex-shrink-0 me-2 blue-circle"
                        ></div>
                        <div class="text-bs-inter-reg-grey-dark-mid-13s-18l">
                          {{ survey.adviceGiven }} - {{ survey.frequency }} - {{ survey.remarks }}
                        </div>
                      </div>

                      <!-- Mobile-only: progress section -->
                      <div
                        class="d-md-none mt-2 ps-4 text-bs-inter-reg-black-light-12s-15l progress-mobile"
                      >
                        <span class="text-bs-inter-medium-grey-mid-12s-15l me-1"
                          >Your Progress:</span
                        >

                        <!-- Editable dropdown for latest submission -->
                        <ng-container *ngIf="first; else readonlyMobile">
                          <div class="follow-dropdown d-inline-block">
                            <select
                              [(ngModel)]="survey.followStatus"
                              (ngModelChange)="onFollowStatusChange(submission)"
                            >
                              <option value="" disabled>Select</option>
                              <option value="following">I am Following</option>
                              <option value="not-following">I am not Following</option>
                            </select>
                            <img
                              class="dropdown-icon"
                              src="./assets/icons/dropdown.svg"
                              alt="dropdown icon"
                            />
                          </div>
                        </ng-container>

                        <!-- Readonly for previous -->
                        <ng-template #readonlyMobile>
                          {{
                            survey.followStatus === 'following'
                              ? 'I am Following'
                              : survey.followStatus === 'not-following'
                                ? 'I am not Following'
                                : 'Pending'
                          }}
                        </ng-template>
                      </div>
                    </div>

                    <!-- Desktop version -->
                    <div
                      class="text-bs-inter-reg-black-light-13s-17l text-bs-inter-reg-black-light-14s-17l mt-2 mt-md-0 text-md-end w-25 w-md-auto d-none d-md-inline-block"
                    >
                      <!-- Editable dropdown for latest submission -->
                      <div *ngIf="first; else readonlyDesktop" class="follow-dropdown">
                        <select
                          [(ngModel)]="survey.followStatus"
                          (ngModelChange)="onFollowStatusChange(submission)"
                        >
                          <option value="" disabled>Select</option>
                          <option value="following" selected>I am Following</option>
                          <option value="not-following">I am not Following</option>
                        </select>
                        <img
                          class="dropdown-icon"
                          src="./assets/icons/dropdown.svg"
                          alt="dropdown icon"
                        />
                      </div>

                      <!-- Readonly for previous -->
                      <ng-template #readonlyDesktop>
                        {{
                          survey.followStatus === 'following'
                            ? 'I am Following'
                            : survey.followStatus === 'not-following'
                              ? 'I am not Following'
                              : 'Pending'
                        }}
                      </ng-template>
                    </div>
                  </div>
                </div>

                <!-- Feedback section -->
                <div
                  *ngIf="submission.feedback && submission.feedback.trim() !== ''"
                  class="d-flex align-items-center justify-content-md-start justify-content-center gap-5 gap-md-2 rounded mt-2 feedback-section py-cs-5 pe-3"
                >
                  <div class="d-flex ms-md-3 gap-1">
                    <img src="./assets/icons/feedback.svg" alt="feedback" />
                    <span class="text-bs-inter-medium-purple-12s-15l ps-cs-6">Feedback</span>
                  </div>

                  <div class="text-bs-inter-reg-grey-medium-light-13s-18l ps-cs-28">
                    {{ submission.feedback }}
                  </div>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-template #noData>
            <div class="text-center text-muted mt-5">No history available</div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>
</div>
